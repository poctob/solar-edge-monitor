# SolarEdge Azure Functions Monitor

This project monitors SolarEdge inverter power output using Azure Functions and sends email alerts when power generation falls below configured thresholds.

## Architecture

- **CheckInverterOutput**: HTTP-triggered function for on-demand power checking
- **CheckPowerOutputTimer**: Timer-triggered function that runs daily at 10 PM UTC
- **Shared Services**: Modular architecture with data management and email services

## Principle of Operation

This service polls SolarEdge API for inverter power output. If last reported output is less than the threshold value, an alert is generated.
The API call checks inverter energy produced between 12 p.m and 1 p.m.
Alert is generated by sending an email.
Every inverter in the SolarEdge site account will be checked.

## Prerequisites

- Python 3.9+ (tested with Python 3.12)
- Azure Functions Core Tools v4
- Azure Storage Emulator (Azurite) for local development
- SolarEdge API access
- SendGrid account for email notifications

## Setup

1. **Clone and Navigate**
   ```bash
   cd /home/alex/Projects/SolarEdge/solaredgefunction
   ```

2. **Install Dependencies**
   ```bash
   pip install -r requirements.txt
   ```

3. **Configure Environment**
   ```bash
   cp .env.sample .env
   # Edit .env with your actual API keys and configuration
   ```

## Implementation Details

This service is written to run as Azure Function, but it can be easily adopted to run on other cloud platforms or locally.
There are two functions:
1. **Timer triggered**: runs every day at 22:00 GMT.
2. **HTTP triggered**: takes a single query parameter **date** in **YYYY-MM-DD** format ex: `?date=2021-08-21`. HTTP trigger can be used to view inverter output and check inverter power for any day in the past. Function URL by default is:
   `https://<your function host url>/api/CheckInverterOutput?date=<date parameter>`

## Local Development

1. **Start Azurite (Azure Storage Emulator)**
   ```bash
   azurite --silent --location __azurite_db__ --debug __azurite_debug.log
   ```

2. **Run Functions Locally**
   ```bash
   func host start
   ```

3. **Test Functions**
   - HTTP Function: `GET http://localhost:7071/api/CheckInverterOutput?date=2025-10-01`
   - Timer Function: Triggers automatically or use Azure portal for manual trigger

## Configuration

Configure `local.settings.json` with your configuration values:

| Variable | Description | Example |
|----------|-------------|---------|
| `alertPowerThreshold` | Minimum power threshold in Watts | `200` |
| `baseURL` | SolarEdge API base URL | `https://monitoringapi.solaredge.com/` |
| `siteId` | Your SolarEdge site ID | `945029` |
| `solarEdgeApiKey` | SolarEdge API key | `YOUR_API_KEY` |
| `sendGridApiKey` | SendGrid API key | `SG.xxx` |
| `toEmail` | Alert recipient email | `alerts@example.com` |
| `fromEmail` | Alert sender email | `system@example.com` |

## Security Notes

⚠️ **Important**: Never commit sensitive data to version control
- Keep API keys in `local.settings.json` (already gitignored)
- Use Azure Key Vault for production secrets
- Rotate API keys regularly
